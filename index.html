<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Graduaci√≥n Escolar</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #0F3B6B; --primary-light: #1a5490; --primary-dark: #082555; --danger: #dc2626; --success: #059669; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0F3B6B 0%, #082555 100%); color: #374151; line-height: 1.6; min-height: 100vh; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .login-box h2 { text-align: center; margin-bottom: 10px; color: var(--primary); font-size: 28px; }
        .login-box p { text-align: center; margin-bottom: 30px; color: #6b7280; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #374151; }
        input { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(15, 59, 107, 0.1); }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .login-btn:hover { background: var(--primary-light); }
        .alert { padding: 12px; margin-bottom: 20px; border-radius: 6px; display: none; }
        .alert.active { display: block; }
        .alert.error { background: #fee2e2; color: #7f1d1d; border-left: 4px solid var(--danger); }
        .dashboard { display: flex; height: 100vh; background: #1f2937; }
        .dashboard.hidden { display: none; }
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 20px; overflow-y: auto; }
        .sidebar-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h1 { font-size: 20px; font-weight: 600; margin-bottom: 5px; }
        .sidebar-header p { font-size: 12px; opacity: 0.8; }
        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 10px; }
        .nav-link { display: block; padding: 12px 15px; background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; text-align: left; font-size: 14px; font-weight: 500; transition: all 0.3s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.2); }
        .main-content { flex: 1; background: #1f2937; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: var(--primary); padding: 20px; border-radius: 10px; color: white; }
        .header h2 { font-size: 24px; font-weight: 600; }
        .logout-btn { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: #b91c1c; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #4b5563; padding: 0; overflow-x: auto; }
        .tab { padding: 12px 20px; background: none; border: none; color: #9ca3af; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; background: #111827; padding: 20px; border-radius: 10px; }
        .tab-content.active { display: block; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #111827; padding: 20px; border-radius: 10px; border-left: 4px solid var(--primary); }
        .card h3 { color: #9ca3af; font-size: 12px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
        .card .value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .table-responsive { overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: #111827; border-radius: 8px; }
        thead { background: var(--primary); color: white; }
        th { padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 12px 15px; border-top: 1px solid #4b5563; color: #d1d5db; }
        tbody tr:hover { background: #1f2937; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: #374151; color: #e5e7eb; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        button:hover { background: var(--primary-light); }
        button.danger { background: var(--danger); }
        button.success { background: var(--success); }
        button.secondary { background: #6b7280; }
        footer { background: var(--primary-dark); color: white; text-align: center; padding: 15px; margin-top: auto; font-size: 12px; }
        @media (max-width: 768px) { .dashboard { flex-direction: column; } .sidebar { width: 100%; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>Subau-1</h2>
            <p>Panel Administrativo</p>
            <div id="alert" class="alert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ingresa tu contrase√±a" required>
                </div>
                <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <div id="dashboard" class="dashboard hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Subau-1</h1>
                <p>Panel Admin</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><button class="nav-link active" data-tab="dashboard">üìä Dashboard</button></li>
                <li class="nav-item"><button class="nav-link" data-tab="registros">üìù Registros</button></li>
                <li class="nav-item"><button class="nav-link" data-tab="eventos">üìÖ Eventos</button></li>
                <li class="nav-item"><button class="nav-link" data-tab="catalogos">‚öôÔ∏è Cat√°logos</button></li>
                <li class="nav-item"><button class="nav-link" data-tab="codigos">üîë C√≥digos</button></li>
                <li class="nav-item"><button class="nav-link" data-tab="exportar">üìä Exportar</button></li>
            </ul>
            <button class="logout-btn" id="logoutBtn" style="width: 100%; margin-top: 30px;">Cerrar Sesi√≥n</button>
        </aside>

        <div class="main-content">
            <div class="header">
                <h2>Dashboard</h2>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab" data-tab="registros">üìù Registros</button>
                <button class="tab" data-tab="eventos">üìÖ Eventos</button>
                <button class="tab" data-tab="catalogos">‚öôÔ∏è Cat√°logos</button>
                <button class="tab" data-tab="codigos">üîë C√≥digos</button>
                <button class="tab" data-tab="exportar">üìä Exportar</button>
            </div>

            <div id="dashboardTab" class="tab-content active">
                <div class="cards-grid">
                    <div class="card"><h3>Total Eventos</h3><div class="value" id="totalEventos">0</div></div>
                    <div class="card"><h3>Total Alumnos</h3><div class="value" id="totalAlumnos">0</div></div>
                    <div class="card"><h3>Total Acompa√±antes</h3><div class="value" id="totalAcompa√±antes">0</div></div>
                    <div class="card"><h3>Instituciones</h3><div class="value" id="totalInstituciones">0</div></div>
                </div>
            </div>

            <div id="registrosTab" class="tab-content">
                <input type="text" id="searchAlumno" placeholder="Buscar alumno..." style="max-width: 300px; margin-bottom: 20px;">
                <div class="table-responsive">
                    <table id="alumnosTable">
                        <thead><tr><th>Apellido</th><th>Nombre</th><th>Mesa</th><th>Acompa√±antes</th><th>Acciones</th></tr></thead>
                        <tbody id="alumnosList"></tbody>
                    </table>
                </div>
            </div>

            <div id="eventosTab" class="tab-content">
                <button id="nuevoEventoBtn" style="margin-bottom: 20px;">+ Nuevo Evento</button>
                <div id="eventosForm" style="display: none; background: #111827; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: white; margin-bottom: 15px;">Crear Evento</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="color: #e5e7eb;">Nombre:</label>
                            <input type="text" id="eventoNombre" placeholder="Nombre del evento">
                        </div>
                        <div class="form-group">
                            <label style="color: #e5e7eb;">Fecha:</label>
                            <input type="date" id="eventoFecha">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="color: #e5e7eb;">Local:</label>
                            <select id="eventoLocal"></select>
                        </div>
                        <div class="form-group">
                            <label style="color: #e5e7eb;">Instituci√≥n:</label>
                            <select id="eventoInstitucion"></select>
                        </div>
                    </div>
                    <button id="guardarEventoBtn">Guardar Evento</button>
                    <button id="cancelarEventoBtn" class="secondary">Cancelar</button>
                </div>
                <div class="table-responsive">
                    <table id="eventosTable">
                        <thead><tr><th>Nombre</th><th>Fecha</th><th>Local</th><th>Alumnos</th><th>Acciones</th></tr></thead>
                        <tbody id="eventosList"></tbody>
                    </table>
                </div>
            </div>

            <div id="catalogosTab" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: white; margin-bottom: 15px;">Instituciones</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="newInstitucion" placeholder="Nueva instituci√≥n" style="flex: 1;">
                            <button id="addInstitucionBtn">Agregar</button>
                        </div>
                        <div id="institucionesList"></div>
                    </div>
                    <div>
                        <h3 style="color: white; margin-bottom: 15px;">Grados</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="newGrado" placeholder="Nuevo grado" style="flex: 1;">
                            <button id="addGradoBtn">Agregar</button>
                        </div>
                        <div id="gradosList"></div>
                    </div>
                    <div>
                        <h3 style="color: white; margin-bottom: 15px;">Secciones</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="newSeccion" placeholder="Nueva secci√≥n" style="flex: 1;">
                            <button id="addSeccionBtn">Agregar</button>
                        </div>
                        <div id="seccionesList"></div>
                    </div>
                    <div>
                        <h3 style="color: white; margin-bottom: 15px;">Locales</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="newLocal" placeholder="Nuevo local" style="flex: 1;">
                            <button id="addLocalBtn">Agregar</button>
                        </div>
                        <div id="localesList"></div>
                    </div>
                </div>
            </div>

            <div id="codigosTab" class="tab-content">
                <button id="generarCodigoBtn" style="margin-bottom: 20px;">+ Generar C√≥digo</button>
                <div class="table-responsive">
                    <table id="codigosTable">
                        <thead><tr><th>C√≥digo</th><th>Evento</th><th>Estado</th><th>Creado</th><th>Acciones</th></tr></thead>
                        <tbody id="codigosList"></tbody>
                    </table>
                </div>
            </div>

            <div id="exportarTab" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: white; margin-bottom: 15px;">Exportar Reportes</h3>
                        <button id="exportPdfBtn" style="width: 100%; margin-bottom: 10px;">üìÑ Exportar PDF</button>
                        <button id="exportExcelBtn" style="width: 100%; margin-bottom: 10px;">üìä Exportar Excel</button>
                        <button id="exportCsvBtn" style="width: 100%;">üìã Exportar CSV</button>
                    </div>
                    <div>
                        <h3 style="color: white; margin-bottom: 15px;">URL Plantilla</h3>
                        <label style="color: #e5e7eb; display: block; margin-bottom: 10px;">URL Google Drive:</label>
                        <input type="url" id="urlPlantilla" placeholder="https://drive.google.com/..." style="margin-bottom: 10px;">
                        <button id="guardarUrlPlantilla">Guardar URL</button>
                        <div id="urlPlantillaGuardada" style="margin-top: 15px; color: #10b981;"></div>
                    </div>
                </div>
            </div>

            <footer>
                <p>Sistema de Graduaci√≥n Escolar ¬© 2025 - Subau-1</p>
            </footer>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let currentUser = null;

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await supabase.from('usuarios').select('*').eq('usuario', username).single();
                if (error || !data) {
                    showAlert('Usuario o contrase√±a incorrectos', 'error');
                    return;
                }
                if (password === 'SUBAUFA-1') {
                    currentUser = data;
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadDashboard();
                    loadCatalogos();
                    loadEventos();
                    loadAlumnos();
                    loadCodigos();
                } else {
                    showAlert('Contrase√±a incorrecta', 'error');
                }
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        // LOGOUT
        document.getElementById('logoutBtn').addEventListener('click', () => {
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('loginForm').reset();
        });

        // LOAD DASHBOARD
        async function loadDashboard() {
            try {
                const [eventos, alumnos, acompa√±antes, instituciones] = await Promise.all([
                    supabase.from('eventos').select('id'),
                    supabase.from('alumnos').select('id'),
                    supabase.from('acompa√±antes').select('id'),
                    supabase.from('catalogos').select('id').eq('tipo', 'institucion')
                ]);

                document.getElementById('totalEventos').textContent = eventos.data?.length || 0;
                document.getElementById('totalAlumnos').textContent = alumnos.data?.length || 0;
                document.getElementById('totalAcompa√±antes').textContent = acompa√±antes.data?.length || 0;
                document.getElementById('totalInstituciones').textContent = instituciones.data?.length || 0;
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        // LOAD CAT√ÅLOGOS
        async function loadCatalogos() {
            try {
                const { data } = await supabase.from('catalogos').select('*').order('tipo');
                const locales = data.filter(d => d.tipo === 'local');
                const instituciones = data.filter(d => d.tipo === 'institucion');
                const grados = data.filter(d => d.tipo === 'grado');
                const secciones = data.filter(d => d.tipo === 'seccion');

                document.getElementById('eventoLocal').innerHTML = locales.map(l => `<option value="${l.id}">${l.valor}</option>`).join('');
                document.getElementById('eventoInstitucion').innerHTML = instituciones.map(i => `<option value="${i.id}">${i.valor}</option>`).join('');

                document.getElementById('institucionesList').innerHTML = instituciones.map(i => `<div style="background: #111827; padding: 10px; margin-bottom: 10px; border-radius: 6px; color: #e5e7eb; display: flex; justify-content: space-between;"><span>${i.valor}</span><button onclick="deleteItem('catalogos', ${i.id})" style="background: #dc2626; padding: 5px 10px; font-size: 12px;">X</button></div>`).join('');

                document.getElementById('gradosList').innerHTML = grados.map(g => `<div style="background: #111827; padding: 10px; margin-bottom: 10px; border-radius: 6px; color: #e5e7eb; display: flex; justify-content: space-between;"><span>${g.valor}</span><button onclick="deleteItem('catalogos', ${g.id})" style="background: #dc2626; padding: 5px 10px; font-size: 12px;">X</button></div>`).join('');

                document.getElementById('seccionesList').innerHTML = secciones.map(s => `<div style="background: #111827; padding: 10px; margin-bottom: 10px; border-radius: 6px; color: #e5e7eb; display: flex; justify-content: space-between;"><span>${s.valor}</span><button onclick="deleteItem('catalogos', ${s.id})" style="background: #dc2626; padding: 5px 10px; font-size: 12px;">X</button></div>`).join('');

                document.getElementById('localesList').innerHTML = locales.map(l => `<div style="background: #111827; padding: 10px; margin-bottom: 10px; border-radius: 6px; color: #e5e7eb; display: flex; justify-content: space-between;"><span>${l.valor}</span><button onclick="deleteItem('catalogos', ${l.id})" style="background: #dc2626; padding: 5px 10px; font-size: 12px;">X</button></div>`).join('');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        // TAB NAVIGATION
        document.querySelectorAll('.tab, .nav-link').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                document.querySelectorAll('.tab, .nav-link').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // LOAD EVENTOS
        async function loadEventos() {
            try {
                const { data } = await supabase.from('eventos').select('*');
                document.getElementById('eventosList').innerHTML = (data || []).map(e => `
                    <tr>
                        <td>${e.nombre}</td>
                        <td>${formatDate(e.fecha_evento)}</td>
                        <td>${e.local_id}</td>
                        <td>0</td>
                        <td>
                            <button onclick="deleteItem('eventos', ${e.id})" class="danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        // LOAD ALUMNOS
        async function loadAlumnos() {
            try {
                const { data } = await supabase.from('alumnos').select('*');
                document.getElementById('alumnosList').innerHTML = (data || []).map(a => `
                    <tr>
                        <td>${a.apellido}</td>
                        <td>${a.nombre}</td>
                        <td>${a.numero_mesa || 'N/A'}</td>
                        <td>${a.total_acompa√±antes || 0}</td>
                        <td>
                            <button onclick="deleteItem('alumnos', ${a.id})" class="danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        // CREAR EVENTO
        document.getElementById('nuevoEventoBtn').addEventListener('click', () => {
            document.getElementById('eventosForm').style.display = 'block';
        });

        document.getElementById('cancelarEventoBtn').addEventListener('click', () => {
            document.getElementById('eventosForm').style.display = 'none';
        });

        document.getElementById('guardarEventoBtn').addEventListener('click', async () => {
            const nombre = document.getElementById('eventoNombre').value;
            const fecha = document.getElementById('eventoFecha').value;
            const local = document.getElementById('eventoLocal').value;
            const institucion = document.getElementById('eventoInstitucion').value;

            if (!nombre || !fecha || !local || !institucion) {
                showAlert('Por favor completa todos los campos', 'error');
                return;
            }

            try {
                await supabase.from('eventos').insert([{
                    nombre,
                    fecha_evento: fecha,
                    local_id: local,
                    institucion_id: institucion
                }]);
                showAlert('Evento creado', 'success');
                document.getElementById('eventosForm').style.display = 'none';
                document.getElementById('eventoNombre').value = '';
                document.getElementById('eventoFecha').value = '';
                loadEventos();
                loadDashboard();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        // AGREGAR CAT√ÅLOGOS
        document.getElementById('addInstitucionBtn').addEventListener('click', async () => {
            const valor = document.getElementById('newInstitucion').value;
            if (!valor) return;
            try {
                await supabase.from('catalogos').insert([{ tipo: 'institucion', valor }]);
                document.getElementById('newInstitucion').value = '';
                loadCatalogos();
                showAlert('Instituci√≥n agregada', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        document.getElementById('addGradoBtn').addEventListener('click', async () => {
            const valor = document.getElementById('newGrado').value;
            if (!valor) return;
            try {
                await supabase.from('catalogos').insert([{ tipo: 'grado', valor }]);
                document.getElementById('newGrado').value = '';
                loadCatalogos();
                showAlert('Grado agregado', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        document.getElementById('addSeccionBtn').addEventListener('click', async () => {
            const valor = document.getElementById('newSeccion').value;
            if (!valor) return;
            try {
                await supabase.from('catalogos').insert([{ tipo: 'seccion', valor }]);
                document.getElementById('newSeccion').value = '';
                loadCatalogos();
                showAlert('Secci√≥n agregada', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        document.getElementById('addLocalBtn').addEventListener('click', async () => {
            const valor = document.getElementById('newLocal').value;
            if (!valor) return;
            try {
                await supabase.from('catalogos').insert([{ tipo: 'local', valor }]);
                document.getElementById('newLocal').value = '';
                loadCatalogos();
                showAlert('Local agregado', 'success');
            } catch (err) {
                showAlert('Error: ' +err.message, 'error');
            }
        });

        // GENERAR C√ìDIGO
        document.getElementById('generarCodigoBtn').addEventListener('click', async () => {
            try {
                const codigo = generateCode(8);
                await supabase.from('codigos_acceso').insert([{ codigo, activo: true }]);
                showAlert('C√≥digo generado: ' + codigo, 'success');
                loadCodigos();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        // CARGAR C√ìDIGOS
        async function loadCodigos() {
            try {
                const { data } = await supabase.from('codigos_acceso').select('*').order('creado_en', { ascending: false });
                document.getElementById('codigosList').innerHTML = (data || []).map(c => `
                    <tr>
                        <td><strong>${c.codigo}</strong></td>
                        <td>${c.evento_id || 'Sin asignar'}</td>
                        <td>${c.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</td>
                        <td>${formatDate(c.creado_en)}</td>
                        <td>
                            <button onclick="deleteItem('codigos_acceso', ${c.id})" class="danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        // EXPORTAR PDF
        document.getElementById('exportPdfBtn').addEventListener('click', async () => {
            try {
                const { data } = await supabase.from('alumnos').select('*');
                const html = `
                    <h2>Reporte de Alumnos - Graduaci√≥n Escolar</h2>
                    <p>Generado: ${new Date().toLocaleDateString('es-ES')}</p>
                    <table border="1">
                        <thead>
                            <tr>
                                <th>Apellido</th>
                                <th>Nombre</th>
                                <th>Mesa</th>
                                <th>Acompa√±antes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data || []).map(a => `
                                <tr>
                                    <td>${a.apellido}</td>
                                    <td>${a.nombre}</td>
                                    <td>${a.numero_mesa || '-'}</td>
                                    <td>${a.total_acompa√±antes}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.html(html, { callback: pdf => pdf.save('reporte_alumnos.pdf') });
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        // EXPORTAR EXCEL
        document.getElementById('exportExcelBtn').addEventListener('click', async () => {
            try {
                const { data } = await supabase.from('alumnos').select('*');
                exportToExcel(data || [], 'reporte_alumnos.xlsx');
                showAlert('Excel exportado', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        // EXPORTAR CSV
        document.getElementById('exportCsvBtn').addEventListener('click', async () => {
            try {
                const { data } = await supabase.from('alumnos').select('*');
                exportToCSV(data || [], 'reporte_alumnos.csv');
                showAlert('CSV exportado', 'success');
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        });

        // GUARDAR URL PLANTILLA
        document.getElementById('guardarUrlPlantilla').addEventListener('click', () => {
            const url = document.getElementById('urlPlantilla').value;
            if (!url) {
                showAlert('Ingresa una URL', 'error');
                return;
            }
            saveToLocalStorage('urlPlantilla', url);
            document.getElementById('urlPlantillaGuardada').textContent = '‚úÖ URL guardada: ' + url;
            showAlert('URL guardada', 'success');
        });

        // ELIMINAR ITEM
        async function deleteItem(tabla, id) {
            if (!confirm('¬øEst√°s seguro?')) return;
            try {
                await supabase.from(tabla).delete().eq('id', id);
                showAlert('Eliminado exitosamente', 'success');
                loadDashboard();
                loadEventos();
                loadAlumnos();
                loadCodigos();
                loadCatalogos();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        // Cargar datos al inicio
        loadCodigos();
    </script>
</body>
</html>


